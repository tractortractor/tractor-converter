<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

<h3>Как редактировать *.m3d/*.a3d</h3>
<ol>
  <li>Откройте modes/path_to_vangers_data_dir.bat в любом текстовом редакторе. Замените значение переменной PATH_TO_VANGERS_DATA_DIR на путь к папке "data" Вангеров. Она содержит файл "game.lst", папку "resource" и другие ресурсы игры. В Windows некоторые символы в пути, "!" например, будут неправильно восприниматься batch скриптом, поэтому желательно использовать только буквы и цифры. *.bat скрипты заменены *.sh скриптами в Linux и macOS версиях.</li>
  <li>Запустите modes/3d/m3d_to_obj.bat.</li>
  <li>Теперь папка modes/3d/intermediate_obj содержит *.obj файлы с моделями из Вангеров, и их можно редактировать. Смотрите docs/common/3d/3d_models.ods. Если вы хотите отредактировать колеса или точки крепления оружия, смотрите ниже.</li>
  <li>Запустите modes/3d/obj_to_m3d.bat.</li>
  <li>Теперь папка modes/3d/out_m3d содержит отредактированные *.m3d/*.a3d файлы. Вы можете скопировать содержимое этой папки в папку "data" Вангеров, чтобы заменить оригинальные модели на отредактированные. Стоит создать резервную копию оригинальных данных перед тем, как это делать.</li>
</ol>

<h3>Более подробно</h3>
<ul>
  <li><p>Все модели должны иметь 3 вертекса на полигон.</p></li>
  <li>
    <p>По умолчанию объем, центр масс и тензор инерции генерируются автоматически. Чтобы эти значения сгенерировались верно, в противном случае возможны проблемы во время игры, модель должна быть закрытой:</p>
    <ul>
      <li><p>без дыр в мешах;</p></li>
      <li><p>без пересечений полигонов;</p></li>
      <li><p>без полигонов внутри мешей;</p></li>
      <li>
        <p>все нормали полигонов должны смотреть либо внутрь,</p>
        <img src="../images/3d_normals_right_in.jpg">
        <p>либо наружу,</p>
        <img src="../images/3d_normals_right_out.jpg">
        <p>но не в противоположные стороны.</p>
        <img src="../images/3d_normals_wrong.jpg">
      </li>
    </ul>
  </li>
  <li>
    <p>По умолчанию при конвертации из *.obj в *.m3d:</p>
    <ul>
      <li>модель сдвигается таким образом, что центр ее экстремальных точек совпадает с началом координат;</li>
      <li>генерируются новые нормали вертексов;</li>
      <li>генерируются новые bound модели.</li>
    </ul>
  </li>
  <li>
    <p>*.m3d/*.a3d файлы состоят из нескольких моделей. При  конвертации *.m3d/*.a3d в *.obj для каждой из этих моделей создается файл *.obj.</p>
    <ul>
      <li>
        <p>У *.m3d всегда есть главная модель. Пример имени obj файла: m5_main.obj, где "m5" - имя *.m3d файла.</p>
        <p>Файл *.m3d мехоса может иметь несколько моделей обломков. Пример имени obj файла: m5_debris_6.obj, где "m5" - имя *.m3d файла, "6" - порядковый номер обломка. Нумерация моделей обломков должна начинаться с 1. Номера нельзя пропускать. Если есть обломки 1 и 3, то должен присутствовать и обломок 2.</p>
      </li>
      <li>
        <p>В файле *.a3d содержатся несколько моделей. Каждая модель - кадр анимации. Пример имени obj файла: a2_4.obj, где "a2" - имя *.a3d файла, "4" - кадр анимации. Нумерация должна начинаться с 1. Номера нельзя пропускать. Если есть кадры 1 и 3, то должен присутствовать и кадр 2.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>При конвертации из *.m3d/*.a3d в *.obj модель скалируется, используя параметр scale_size из конфигурационных файлов. При конвертации обратно в *.m3d/*.a3d новый scale_size рассчитывается и используется при генерации моделей и конфигурационных файлов.</p>
    <ul>
      <li>Если у вновь созданной или отредактированной модели оружия значение scale_size больше, чем у старых моделей оружия, она не будет правильно рендериться со старыми *.m3d файлами мехосов. В таком случае нужно использовать *.m3d файлы мехосов, сгенерированные с *.m3d файлом нового оружия.</li>
      <li>По умолчанию если scale_size, который был рассчитан из размера модели, больше, чем 0.560547, то программа сделает scale_size равным 0.560547. Рассчитанный scale_size больше 0.560547, если дистанция между центром модели и самой дальней ее точкой больше 68.947281.</li>
    </ul>
  </li>
  <li>
    <p>Материалы полигонов используются, чтобы определить цвета в игре для этих полигонов и обозначить специальные полигоны.</p>
    <p>Игра использует палитру из 256 цветов. Каждому материалу назначены несколько цветов - от темного к светлому. Последний цвет в палитре никогда не используется, поэтому материал body_green, например, имеет на 1 цвет меньше.</p>
    <p>Цвета в диапазоне от 0 до 127 различаются в каждом мире/цикле и используются ландшафтом.</p>
    <p>Цвета в диапазоне от 88 до 119 меняются каждую секунду.</p>
    <p>Цвета материала определяются параметрами offset и shift.</p>
    <ul>
      <li>Offset указывает позицию начального цвета.</li>
      <li>
        <p>Shift определяет количество цветов. Точная формула: 1 + 123/2^shift. Результат округляется к меньшему.</p>
        <table border=1>
          <tr>
            <th>Shift</th>
            <th>Цветов на материал</th>
          </tr>
          <tr>
            <td>7</td>
            <td>1</td>
          </tr>
          <tr>
            <td>6</td>
            <td>2</td>
          </tr>
          <tr>
            <td>5</td>
            <td>4</td>
          </tr>
          <tr>
            <td>4</td>
            <td>8</td>
          </tr>
          <tr>
            <td>3</td>
            <td>16</td>
          </tr>
          <tr>
            <td>2</td>
            <td>31</td>
          </tr>
          <tr>
            <td>1</td>
            <td>62</td>
          </tr>
          <tr>
            <td>0</td>
            <td>124</td>
          </tr>
        </table>
      </li>
    </ul>
    <p>Например, материалу с параметрами offset 32 и shift 4 будут назначены цвета с индексами от 32 до 39.</p>
    <p>Папка docs/common/3d/materials_table содержит полный список материалов для всех миров и циклов.</p>
    <p>Следующие материалы - специальные и назначены только определенным полигонам, их не стоит назначать любым другим полигонам.</p>
    <ul>
      <li>zero_reserved</li>
      <li>center_of_mass</li>
      <li>attachment_point</li>
    </ul>
  </li>
  <li>
    <p>У каждого *.m3d/*.a3d файла может быть кастомный набор цветов для материала body. При помощи материала типа body_offset_*_shift_* можно указать offset и shift этого кастомного набора цветов.</p>
    <ul>
      <li>Нельзя указывать несколько наборов цветов для одной и той же модели. Например, если уже используется материал, допустим, body_offset_0_shift_0, то использование материалов, предположим, body_offset_1_shift_0 или body_offset_0_shift_1 приведет к ошибке.</li>
      <li>В одной модели могут быть и сам материал body, и материал типа body_offset_*_shift_*.</li>
      <li>Только набор цветов главной модели используется при генерации *.m3d файла. Только набор цветов первой анимированной модели используется при генерации *.a3d файла. Материалы типа body_offset_*_shift_* можно использовать в других моделях, но это никак не повлияет на цвета конечных *.m3d/*.a3d файлов.</li>
    </ul>
  </li>
  <li>
    <p>Полигоны с окончанием материала *_wheel_* в модели мехоса используются, чтобы определить, где расположены колеса и какими свойствами они обладают. Пример: tube_wheel_2, где "tube" - название материала, "_wheel_" - окончание, обозначающее колесо, "2" - номер колеса.</p>
    <ul>
      <li>У всех окончаний материалов, которые обозначают колесо, должен быть порядковый номер в конце имени материала. Нумерация должна начинаться с 1. Номера нельзя пропускать. Если есть *_wheel_1 и *_wheel_3, то должен присутствовать и *_wheel_2. Нельзя назначать разным колесам один и тот же номер.</li>
      <li>Есть два свойства, которые можно назначить колесу: "steer" и "ghost". Эти свойства указываются с окончанием материала. Например, у рулевого призрачного колеса номер 1 окончание материала будет "*_wheel_steer_ghost_1" или "*_wheel_ghost_steer_1". Все полигоны одного колеса должны иметь одинаковый набор свойств.</li>
      <li>Рулевые колеса влияют на способность мехоса поворачиваться, поэтому по крайней мере одно такое колесо должно присутствовать в любом мехосе, иначе его будет невозможно повернуть. При повороте в игре все рулевые колеса тоже визуально поворачиваются.</li>
      <li>Призрачное свойство означает, что модель колеса будет убрана при конвертации в *.m3d, но у мехоса будет информация об этом колесе. Поэтому в игре мехос будет вести себя так, будто колесо есть.</li>
      <li>При конвертации из *.m3d в *.obj колеса, которые не являются рулевыми, извлекаются как призрачные.</li>
    </ul>
  </li>
  <li>
    <p>Полигоны с окончанием материала *_weapon_* в модели мехоса показывают, где оружие будет установлено с текущим расположением оружейных слотов. Пример: tube_weapon_3, где "tube" - название материала, "_weapon_" - окончание, обозначающее оружие, "3" - номер оружия. Они удаляются при конвертации из *.obj в *.m3d.</p>
  </li>
  <li>
    <p>Полигоны с материалом attachment_point являются частью модели точки крепления оружия.</p>
    <ul>
      <li>Эту модель нельзя изменять или скалировать, но передвигать ее можно.</li>
      <li>При конвертации *.obj в *.m3d все полигоны с этим материалом удаляются.</li>
    </ul>
    <ul>
      <li>
        <p>Когда они являются частью модели оружия, то указывают, где находится его точка крепления.</p>
        <ul>
          <li>Нельзя вращать.</li>
        </ul>
      </li>
      <li>
        <p>Когда они являются частью модели мехоса, указывают, где находятся слоты оружия.</p>
        <ul>
          <li>В конце имени материала должно быть окончание, которое указывает, что материал является оружием. Пример: "attachment_point_weapon_3".</li>
          <li>Максимум может быть только 3 оружейных слота.</li>
          <li>Можно повернуть только вокруг оси y, направление которой совпадает с направлением движения мехоса вперед.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p>Файл *.cfg генерируется для каждого *.m3d/*.a3d файла при конвертации *.m3d/*.a3d в *.obj. Этот конфигурационный файл используется при конвертации обратно в *.m3d/*.a3d.</p>
    <ul>
      <li>
        <p>В нем можно указать кастомный объем для каждой модели.</p>
        <ul>
          <li><p>Влияет на генерацию тензора инерции и центра масс.</p></li>
          <li>
            <p>Используется для определения массы.</p>
            <ul>
              <li>Участвует во многих расчетах.</li>
              <li>Участвует в определении силы тарана.</li>
            </ul>
          </li>
        </ul>
      </li>
      <li><p>В нем можно указать, какие модели должны использовать кастомный центр масс. Больше информации о центре масс ниже.</p></li>
      <li>
        <p>В нем можно указать кастомный тензор инерции для каждой модели.</p>
        <ul>
          <li>Используется во многих расчетах.</li>
        </ul>
      </li>
    </ul>
    <p>Эти конфигурационные файлы не стоит использовать в большинстве случаев, поскольку объем, центр масс и тензор инерции генерируются автоматически.</p>
  </li>
  <li>
    <p>Полигоны с материалом center_of_mass являются частью модели центра масс.</p>
    <ul>
      <li>Эту модель нельзя менять, скалировать или поворачивать. Ее можно двигать.</li>
      <li>Генерируется при конвертации *.m3d в *.obj только тогда, когда опция extract_center_of_mass указана в конфигурационном файле.</li>
      <li>Используется только тогда, когда соответствующая опция указана в конфигурации *.m3d/*.a3d файла.</li>
      <li>Используется, чтобы вручную указать центр масс, который влияет на генерацию тензора инерции. Автоматическая генерация рекомендуется в большинстве случаев.</li>
    </ul>
  </li>
</ul>
